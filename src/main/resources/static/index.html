<!DOCTYPE html>
<html>
<head>
    <title>WebSocket STOMP Test Client</title>
    <style>
        body { font-family: sans-serif; }
        #messages { border: 1px solid #ccc; padding: 10px; margin-top: 10px; height: 300px; overflow-y: scroll; }
        .message { margin-bottom: 5px; }
        .server-msg { color: blue; }
        .sent-msg { color: green; }
        .error-msg { color: red; }
    </style>
</head>
<body>
<h2>WebSocket STOMP Test Client</h2>
<div>
    <label for="token">JWT Token:</label>
    <input type="text" id="token" size="70" placeholder="Dán JWT token của bạn vào đây"/>
</div>
<br>
<div>
    <button id="connect" onclick="connect()">Connect</button>
    <button id="disconnect" onclick="disconnect()" disabled>Disconnect</button>
</div>
<br>
<div>
    <label for="message">Message:</label>
    <input type="text" id="message" placeholder="Gõ tin nhắn..."/>
    <button id="send" onclick="sendMessage()" disabled>Send</button>
</div>
<div id="messages"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script type="text/javascript">
    let stompClient = null;

    function log(message, className) {
        const messagesDiv = document.getElementById('messages');
        const p = document.createElement('p');
        p.className = 'message ' + className;
        p.appendChild(document.createTextNode(message));
        messagesDiv.appendChild(p);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function connect() {
        const token = document.getElementById('token').value;
        if (!token) {
            log('ERROR: Please provide a JWT Token!', 'error-msg');
            return;
        }

        // Dùng SockJS để kết nối tới endpoint /ws của bạn
        const socket = new SockJS('http://localhost:8081/ws');
        stompClient = Stomp.over(socket);

        const headers = {
            'Authorization': 'Bearer ' + token
        };

        stompClient.connect(headers, function (frame) {
            log('Connected: ' + frame, 'server-msg');
            document.getElementById('connect').disabled = true;
            document.getElementById('disconnect').disabled = false;
            document.getElementById('send').disabled = false;

            // Đăng ký nghe trên kênh public
            stompClient.subscribe('/topic/public', function (message) {
                const receivedMessage = JSON.parse(message.body);
                log(receivedMessage.sendername + ": " + receivedMessage.content, 'received-msg');
            });

            // (Tùy chọn) Đăng ký nghe trên kênh private của bạn
            stompClient.subscribe('/user/queue/reply', function (message) {
                const receivedMessage = JSON.parse(message.body);
                log('PRIVATE - ' + receivedMessage.sendername + ": " + receivedMessage.content, 'server-msg');
            });

        }, function(error) {
            log('Connection error: ' + error, 'error-msg');
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        log("Disconnected", 'server-msg');
        document.getElementById('connect').disabled = false;
        document.getElementById('disconnect').disabled = true;
        document.getElementById('send').disabled = true;
    }

    function sendMessage() {
        const messageContent = document.getElementById('message').value;
        const chatMessage = {
            content: messageContent,
            type: 'CHAT'
        };

        // Gửi tin nhắn đến @MessageMapping("/chat.sendMessage")
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
        log("You sent: " + messageContent, 'sent-msg');
        document.getElementById('message').value = '';
    }
</script>
</body>
</html>